import 'package:flutter/material.dart';
import 'package:flutter_appp/constants/task_constants.dart';
import 'package:flutter_appp/services/task_actions.dart';
import 'package:flutter_appp/services/task_analyzer.dart';

class AddTaskDialog extends StatefulWidget {
  final Function onTaskAdded;

  const AddTaskDialog({required this.onTaskAdded});

  @override
  _AddTaskDialogState createState() => _AddTaskDialogState();
}

class _AddTaskDialogState extends State<AddTaskDialog> {
  final _formKey = GlobalKey<FormState>();
  late String title = "";
  late String comment = "";
  late String category = "–†–∞–±–æ—Ç–∞";
  late String priority = "medium";
  late int emotionalLoad = 3;
  late DateTime deadline = DateTime.now();
  int reminderOffsetMinutes = 0;
  String? categoryError;
  String? emotionalLoadError;

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É"),
      content: StatefulBuilder(
        builder: (context, setState) {
          return Form(
            key: _formKey,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextFormField(
                  decoration: InputDecoration(labelText: "–ù–∞–∑–≤–∞–Ω–∏–µ"),
                  maxLength: 50,
                  validator: (value) => _validateTitle(value),
                  onChanged: (value) => title = value,
                  onFieldSubmitted: (_) => _analyzeParameters(setState),
                  onEditingComplete: () => _analyzeParameters(setState),
                ),
                TextFormField(
                  decoration: InputDecoration(
                      labelText: "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)"),
                  maxLength: 512,
                  onChanged: (value) => comment = value,
                  onFieldSubmitted: (_) => _analyzeParameters(setState),
                  onEditingComplete: () => _analyzeParameters(setState),
                ),
                _buildCategorySelector(setState),
                _buildPrioritySelector(setState),
                _buildEmotionalLoadSlider(setState),
                _buildAnalysisButton(setState),
                _buildDateTimePicker(setState),
                _buildReminderDropdown(setState),
              ],
            ),
          );
        },
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: Text("–û—Ç–º–µ–Ω–∞"),
        ),
        ElevatedButton(
          onPressed: () => _submitForm(context),
          child: Text("–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É"),
        ),
      ],
    );
  }

  String? _validateTitle(String? value) {
    if (value == null || value.trim().isEmpty) {
      return "–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ";
    } else if (value.length > 50) {
      return "–ú–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤";
    }
    return null;
  }

  Widget _buildCategorySelector(StateSetter setState) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        DropdownButtonFormField<String>(
          value: TaskConstants.categories.contains(category)
              ? category
              : "–î—Ä—É–≥–æ–µ",
          items: TaskConstants.categories.sublist(1).toSet().map((value) {
            return DropdownMenuItem<String>(
              value: value,
              child: Text(value),
            );
          }).toList(),
          onChanged: (value) => setState(() {
            category = value!;
            categoryError = null;
          }),
          decoration: InputDecoration(labelText: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è"),
        ),
        if (categoryError != null)
          Padding(
            padding: EdgeInsets.only(top: 8),
            child: Text(
              categoryError!,
              style: TextStyle(color: Colors.red, fontSize: 12),
            ),
          ),
      ],
    );
  }

  Widget _buildPrioritySelector(StateSetter setState) {
    return DropdownButtonFormField<String>(
      value: priority,
      items: ["high", "medium", "low"].map((value) {
        return DropdownMenuItem<String>(
          value: value,
          child: Text(TaskConstants.getPriorityText(value)),
        );
      }).toList(),
      onChanged: (value) => setState(() => priority = value!),
      decoration: InputDecoration(labelText: "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç"),
    );
  }

  Widget _buildEmotionalLoadSlider(StateSetter setState) {
    return Column(
      children: [
        Slider(
          value: emotionalLoad.toDouble(),
          min: 1,
          max: 5,
          divisions: 4,
          label: emotionalLoad.toString(),
          onChanged: (value) => setState(() {
            emotionalLoad = value.toInt();
            emotionalLoadError = null;
          }),
        ),
        if (emotionalLoadError != null)
          Padding(
            padding: EdgeInsets.only(top: 8),
            child: Text(
              emotionalLoadError!,
              style: TextStyle(color: Colors.red, fontSize: 12),
            ),
          ),
      ],
    );
  }

  Widget _buildAnalysisButton(StateSetter setState) {
    return Padding(
      padding: EdgeInsets.only(top: 16),
      child: ElevatedButton.icon(
        onPressed: () {
          _analyzeCategory(setState);
          _analyzeEmotionalLoad(setState);
        },
        icon: Icon(Icons.auto_awesome),
        label: Text("–û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"),
      ),
    );
  }

  Widget _buildDateTimePicker(StateSetter setState) {
    return ElevatedButton(
      onPressed: () => TaskActions.showDateTimePicker(
        context,
        deadline,
            (newDate) => setState(() => deadline = newDate),
      ),
      child: Text("–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è"),
    );
  }

  Widget _buildReminderDropdown(StateSetter setState) {
    final options = {
      0: "–ù–µ —É–≤–µ–¥–æ–º–ª—è—Ç—å",
      15: "15 –º–∏–Ω—É—Ç",
      60: "1 —á–∞—Å",
      180: "3 —á–∞—Å–∞",
      1440: "1 –¥–µ–Ω—å"
    };

    return Padding(
      padding: const EdgeInsets.only(top: 16.0),
      child: DropdownButtonFormField<int>(
        value: reminderOffsetMinutes,
        onChanged: (value) => setState(() => reminderOffsetMinutes = value!),
        items: options.entries.map((entry) {
          return DropdownMenuItem<int>(
            value: entry.key,
            child: Text(entry.value),
          );
        }).toList(),
        decoration: InputDecoration(labelText: "üîî –ù–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞"),
      ),
    );
  }

  void _submitForm(BuildContext context) {
    if (_formKey.currentState!.validate()) {
      TaskActions.addTask(
        context: context,
        title: title,
        comment: comment,
        category: category,
        priority: priority,
        emotionalLoad: emotionalLoad,
        deadline: deadline,
        reminderOffsetMinutes: reminderOffsetMinutes,
      );
      widget.onTaskAdded();
      Navigator.pop(context);
    }
  }

  void _analyzeParameters(StateSetter setState) {
    if (title.isNotEmpty) {
      _analyzeCategory(setState);
      _analyzeEmotionalLoad(setState);
    }
  }

  void _analyzeCategory(StateSetter setState) {
    TaskAnalyzer.analyzeCategory(
      title: title,
      comment: comment,
      context: context,
      onSuccess: (newCategory) {
        setState(() {
          category = newCategory;
          categoryError = null;
        });
      },
      onError: (error) {
        setState(() {
          categoryError = error;
        });
      },
    );
  }

  void _analyzeEmotionalLoad(StateSetter setState) {
    TaskAnalyzer.analyzeEmotionalLoad(
      title: title,
      comment: comment,
      context: context,
      onSuccess: (newLoad) {
        setState(() {
          emotionalLoad = newLoad;
          emotionalLoadError = null;
        });
      },
      onError: (error) {
        setState(() {
          emotionalLoadError = error;
        });
      },
    );
  }
}